<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.one.mapper.CRecogsMapper">

    <!-- 领取手机号进行电话拨打 -->
    <select id="pickup" resultType="com.web.dto.DtoDBRecogs">
        SELECT
        a.*, b.pickuptime, b.mark
        FROM
        recogs a
        LEFT JOIN batchlog b ON a.batchid = b.batchid
        WHERE
        (
        ISNULL(b.pickuptime)
        OR b.pickuptime  &lt;  NOW()
        )
        AND (
        ISNULL(a.`status`)
        OR a.`status` = 1
        OR a.manualresult = 8
        )
        AND ISNULL(b.batchid)=FALSE
        ORDER BY
            seqid
        LIMIT 0,
         1
    </select>

  <!-- 根据 商户号，手机号，流水号 查询 手机号状态识别记录-->
  <select id="selectRecogs" resultType="mybatis.one.po.DBRecogs">
      SELECT
      a.*
      FROM
      recogs a

      WHERE  1=1
      <if test="batchid != null and batchid != ''" >
          AND a.batchid = #{batchid}
      </if>
      <if test="status != null " >
          AND a.status = #{status}
      </if>
      <if test="result != null " >
          AND a.result = #{result}
      </if>
      <if test="manualresult != null " >
          AND a.manualresult = #{manualresult}
      </if>
      <if test="mobile != null and mobile != ''" >
          AND a.mobile = #{mobile}
      </if>

    ORDER BY
	a.seqid ASC
	
	<if test="pagesize != null" >
		LIMIT #{start}, #{pagesize}
    </if>
	
  </select>
  
  <!-- 根据 商户号，手机号，流水号 查询 手机号状态识别记录, 返回 总数量 -->
  <select id="totalRecogs" resultType="java.lang.Integer" >
  	  SELECT
		COUNT(*)
      FROM
      recogs a

      WHERE  1=1
      <if test="batchid != null and batchid != ''" >
          AND a.batchid = #{batchid}
      </if>
      <if test="status != null " >
          AND a.status = #{status}
      </if>
      <if test="result != null " >
          AND a.result = #{result}
      </if>
      <if test="manualresult != null " >
          AND a.manualresult = #{manualresult}
      </if>
      <if test="mobile != null and mobile != ''" >
          AND a.mobile = #{mobile}
      </if>
  </select>


    <!-- 根据 商户号，批次号， 查询 批次导入记录-->
    <select id="selectBatchLogs" resultType="mybatis.one.po.DBBatchLog">
        SELECT
        a.*
        FROM
        batchlog a

        WHERE  1=1
        <if test="merchid != null and merchid != ''" >
            AND a.merchid = #{merchid}
        </if>
        <if test="batchid != null and batchid != ''" >
            AND a.batchid = #{batchid}
        </if>

        ORDER BY
        a.seqid DESC

        <if test="pagesize != null" >
            LIMIT #{start}, #{pagesize}
        </if>

    </select>

    <!-- 根据 商户号，批次号 查询 批次导入记录, 返回 总数量 -->
    <select id="totalBatchLogs" resultType="java.lang.Integer" >
        SELECT
        COUNT(*)
        FROM
        batchlog a

        WHERE  1=1
        <if test="merchid != null and merchid != ''" >
            AND a.merchid = #{merchid}
        </if>
        <if test="batchid != null and batchid != ''" >
            AND a.batchid = #{batchid}
        </if>
    </select>


    <!--  批量插入案件 -->
    <insert id="insertCaseBatch">
        insert into zncontact ( importbatchid, caseno, serino,
        prelation, pname, ptel, telck,
        ptel1, tel1ck ) values
        <foreach collection="list" item="item" index="index"
                 separator=",">
            ( '${batchid}', #{item.caseNo}, #{item.serino},
            #{item.prelation}, #{item.pname},
            #{item.ptel}, #{item.telck},
          #{item.ptel1}, #{item.tel1ck} )
        </foreach>
    </insert>

    <!--  查询批量案件中的电话号码，过滤重复 -->
    <select id="queryPhone" resultType="com.web.dto.MTMDataDto">
        SELECT DISTINCT a.* FROM
        (
        SELECT DISTINCT ptel as phone, caseno FROM zncontact  WHERE importbatchid=#{batchid}
        UNION
        SELECT DISTINCT ptel1 as phone, caseno FROM zncontact  WHERE importbatchid=#{batchid}
        ) as a  WHERE ISNULL(a.phone)=FALSE AND a.phone &lt;&gt;  ''
        ORDER BY a.caseno
    </select>

    <!--  删除临时表里面，某商户的全部数据 -->
    <delete id="deleteTmpPhoneByMerchId">
        DELETE FROM tmpPhone WHERE merchid=#{merchid}
    </delete>

    <!--  将各个批量插入的案件 的电话号码，批量写入 临时表 -->
    <insert id="insertTmpPhoneBatch">
        insert into tmpPhone ( merchid, phone ) values
        <foreach collection="list" item="item" index="index"
                 separator=",">
            ( ${merchid}, #{item} )
        </foreach>
    </insert>

    <!-- 查询兆能资产 需要写回的数据 -->
    <select id="queryRecogResult" resultType="com.web.dto.DtoDBRecogs">
        SELECT DISTINCT
            a.*, c.caseno,
            c.serino
        FROM
            recogs a
        LEFT JOIN importbatch b ON a.batchid = b.batchid
        LEFT JOIN zncontact c ON b.importbatchid = c.importbatchid
        WHERE
            1 = 1
        AND (c.ptel=a.mobile OR c.ptel1=a.mobile)
        AND a.merchid = 'znadmin'
        AND a. STATUS = 4
        AND (
            a.result = 2
            OR a.result = 3
            OR a.result = 4
            OR a.result = 1
        )
        ORDER BY
            batchid,
            seqid
        LIMIT 0, 1
    </select>

    <!-- 查询临时表的电话号码，过滤掉 recogs表里面 尚未拨打的电话号码 -->
    <select id="selectTmpPhone" resultType="java.lang.String">
        SELECT
            a.phone
        FROM
            tmpPhone a
        WHERE
            merchid = #{merchid} AND
            a.phone NOT IN (
                SELECT
                    mobile
                FROM
                    recogs
                WHERE
                    merchid = #{merchid}
                AND ISNULL(calltime)
            )
    </select>

    <!--  将从临时表得到的过滤过的电话号码，写入 recogs表 继续拨打 -->
    <insert id="insertTmpPhoneToRecogsBatch">
        insert into recogs ( merchid, batchid, mobile, createtime) values
        <foreach collection="list" item="item" index="index"
                 separator=",">
            ( '${merchid}', '${batchid}', #{item}, '${createtime}')
        </foreach>
    </insert>


    <!--  查询债务人案件状态  -->
    <select id="selectForDebtorStatus" resultType="mybatis.one.po.DBZNContact">
        SELECT DISTINCT seqid, caseno,importbatchid, serino, categorize2 FROM zncontact  WHERE prelation='0'
            AND (ISNULL(categorize2) OR categorize2='')
            AND ( telck &lt;&gt;  '' OR tel1ck &lt;&gt;  '' )
    </select>

    <!--  查询债务人可以联系上的  -->
    <select id="countForStatusA">
        select COUNT(b.*) from zncontact b where b.prelation=0
          and ( b.telck='019' or b.tel1ck='019'  or   b.telck='012' or b.tel1ck='012') and caseno=#{caseno}
    </select>

</mapper>